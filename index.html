<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="Diseño sin título.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
  <title>Turno Grua</title>
  <style>
    .copyright {
      text-align: center;
      margin-top: 20px;
      color: #1f1e1e; 
    }
        img {
      max-width: 150px;
      max-height: 150px;
    }
    </style>
  
</head>

<body>
  <h1 style="color: black; font-size: 45px; font-family: 'Arial', sans-serif;">Estado De La Grúa</h1>
  <img src="cso.png" alt="Descripción de la imagen" style="display: block; margin: 0 auto;">
  <label for="noperario">Nombre Operario:</label>
  <input type="text" id="noperario">
  <br><br>

  <label for="placa">Placa del Carro:</label>
  <input type="text" id="placa">
  <br><br>

  <label for="fecha">Fecha y Hora Actual:</label>
  <input type="text" id="fecha" readonly>
  <br><br>

  <label for="estado">Estado de la Grúa (limpia sí/no):</label>
  <input type="text" id="estado">
  <br><br>

  <label for="observaciones">Observaciones y Foto:</label>
  <input type="file" id="observacionesFoto">
  <input type="text" id="observaciones">
  <br><br>

  <label for="novedades">Novedades Mecánicas:</label>
  <input type="text" id="novedades">
  <br><br>

  <label for="kilometraje">Observaciones y Foto de Kilometraje:</label>
  <input type="file" id="kilometrajeFoto">
  <input type="text" id="kilometraje">
  <br><br>

  <label for="gasolina">Observaciones y Foto de Gasolina:</label>
  <input type="file" id="gasolinaFoto">
  <input type="text" id="gasolina">
  <br><br>

  <button id="addBtn" style="background-color: #3498db; color: #fff;" onclick="this.style.backgroundColor='#2c3e50';">Agregar Datos</button>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getStorage, ref as storageRef, uploadString, getDownloadURL} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDblaWYr7qnuOrZxDflz2gilEwc4CgMLA8",
      authDomain: "bd-gruas-crud.firebaseapp.com",
      databaseURL: "https://bd-gruas-crud-default-rtdb.firebaseio.com",
      projectId: "bd-gruas-crud",
      storageBucket: "bd-gruas-crud.appspot.com",
      messagingSenderId: "167496761184",
      appId: "1:167496761184:web:4576d75997e3aebc462805"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase();
    const storage = getStorage();

    const noperarioInput = document.getElementById('noperario');
    const placaInput = document.getElementById('placa');
    const fechaInput = document.getElementById('fecha');
    const estadoInput = document.getElementById('estado');
    const observacionesFotoInput = document.getElementById('observacionesFoto');
    const observacionesInput = document.getElementById('observaciones');
    const novedadesInput = document.getElementById('novedades');
    const kilometrajeFotoInput = document.getElementById('kilometrajeFoto');
    const kilometrajeInput = document.getElementById('kilometraje');
    const gasolinaFotoInput = document.getElementById('gasolinaFoto');
    const gasolinaInput = document.getElementById('gasolina');
    const addBtn = document.getElementById('addBtn');

    function getCurrentDateTime() {
      const now = new Date();
      return now.toLocaleString();
    }

    function uploadFileAndGetUrl(file, folder) {
      const storageRefFolder = storageRef(storage, `${folder}/${file.name}`);
      return uploadString(storageRefFolder, file).then(snapshot => {
        return getDownloadURL(snapshot.ref);
      });
    }

    async function addData() {
      if (
        !noperarioInput.value ||
        !placaInput.value ||
        !estadoInput.value ||
        !observacionesInput.value ||
        !novedadesInput.value ||
        !kilometrajeInput.value ||
        !gasolinaInput.value ||
        !observacionesFotoInput.files[0] ||
        !kilometrajeFotoInput.files[0] ||
        !gasolinaFotoInput.files[0]
      ) {
        alert("Por favor, llene todos los campos del formulario.");
        return;
      }
      const currentDate = new Date();
      const currentDateTime = currentDate.toISOString().replace(/[^\d]/g, ''); 
      const observacionesFoto = observacionesFotoInput.files[0];
      const kilometrajeFoto = kilometrajeFotoInput.files[0];
      const gasolinaFoto = gasolinaFotoInput.files[0];

      const observacionesFotoUrl = await uploadFileAndGetUrl(observacionesFoto, 'observacionesFotos');
      const kilometrajeFotoUrl = await uploadFileAndGetUrl(kilometrajeFoto, 'kilometrajeFotos');
      const gasolinaFotoUrl = await uploadFileAndGetUrl(gasolinaFoto, 'gasolinaFotos');

      set(ref(db, 'EmployeeSet/' + currentDateTime), {
          noperario: {
            primernombre: noperarioInput.value
          },
          placas: {
            placa: placaInput.value
          },
          fecha: getCurrentDateTime(),
          estado: estadoInput.value,
          observaciones: {
            texto: observacionesInput.value,
            foto: observacionesFotoUrl
          },
          novedades: novedadesInput.value,
          kilometraje: {
            texto: kilometrajeInput.value,
            foto: kilometrajeFotoUrl
          },
          gasolina: {
            texto: gasolinaInput.value,
            foto: gasolinaFotoUrl
          }
        })
        .then(() => {
          alert("Datos agregados exitosamente");
          noperarioInput.value = '';
          placaInput.value = '';
          fechaInput.value = '';
          estadoInput.value = '';
          observacionesInput.value = '';
          novedadesInput.value = '';
          kilometrajeInput.value = '';
          gasolinaInput.value = '';
        })
        .catch((error) => {
          alert("Error al agregar datos: " + error.message);
          console.error(error);


        });
    }

    addBtn.addEventListener('click', addData);

    // Autocompletar la fecha al cargar la página
    fechaInput.value = getCurrentDateTime();
  </script>

  <div class="copyright">
    <p>&copy; 2024 Visualización de Datos. Todos los derechos reservados Nelson Fernando Correal Lopez.</p>
  </div>
</body>

</html>
